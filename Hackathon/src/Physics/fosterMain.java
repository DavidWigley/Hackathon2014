package Physics;

import java.awt.Canvas;
import java.awt.Dimension;
import java.awt.Graphics;
import java.awt.Image;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.awt.image.BufferStrategy;
import javax.sound.sampled.AudioInputStream;
import javax.sound.sampled.AudioSystem;
import javax.sound.sampled.Clip;
import javax.swing.ImageIcon;
import javax.swing.JFrame;
import java.util.Random;

public class fosterMain extends Canvas implements Runnable, KeyListener {
	
	/**
	 * @author David Wigley+ Anthony Foster+ Tina Zunino+ Sean Trainor
	 */

	public boolean running = false;
	Random generator=new Random();
	JFrame frame;
	
	public boolean rightPressed = false;
	public boolean leftPressed = false;
	private boolean lowCountChange;
	public float x = 100, y = 100;
	public float velocityX, velocityY;
	public float gravity = 1f;
	
	public boolean isIdle = false;
	public boolean isFalling = false;
	public boolean isJumping = false;
	public boolean isMoving = false;
	
	public boolean facingRight = true;
	
	public boolean lockMovement = false;
	
	public int animID = 0;
	public int animFrames = 0;
	public int phase = 0;
	public int jumpheight=0;
	private int backgroundX = 0;
	private int backgroundX2 = 170;
	private int backgroundX3 = 340;
	private int backgroundX4 = 510;
	private int backgroundX5 = 680;
	private int backgroundX6 = 850;
	private int backgroundX7 = 1020;
	private int currentLow = backgroundX;
	private int currentJumpHeight = 0;
	public boolean finished = false;
	public boolean doJump = false;
	private int oneJump=-76;
	private int movePixels;
	boolean dead, escape, escapePressed, isGrounded;
	int lowestX, groundedY, groundedYCount;
	boolean canGround;
	//jumps
	private int jumpheight1, jumpheight2, jumpheight3, jumpheight4, jumpheight5, jumpheight6, jumpheight7;
	//music
	AudioInputStream backgroundMusic;
	Clip music;
	
	Graphics g;
	
	ImageIcon background = new ImageIcon(getClass().getResource("/resources/background.png"));
	Image picture = background.getImage();
	
	ImageIcon frameIcon = new ImageIcon(getClass().getResource("/resources/background.png"));
	Image icon = frameIcon.getImage();
	
	ImageIcon idle = new ImageIcon(getClass().getResource("/resources/idle.png"));
	Image idlePhase = idle.getImage();
	
	ImageIcon walk1 = new ImageIcon(getClass().getResource("/resources/walk1.png"));
	Image walkPhase1 = walk1.getImage();
	
	ImageIcon walk2 = new ImageIcon(getClass().getResource("/resources/walk2.png"));
	Image walkPhase2 = walk2.getImage();
	
	ImageIcon walk3 = new ImageIcon(getClass().getResource("/resources/walk3.png"));
	Image walkPhase3 = walk3.getImage();
	
	ImageIcon walk4 = new ImageIcon(getClass().getResource("/resources/walk4.png"));
	Image walkPhase4 = walk4.getImage();
	
	ImageIcon walk5 = new ImageIcon(getClass().getResource("/resources/walk5.png"));
	Image walkPhase5 = walk5.getImage();
	
	ImageIcon walk6 = new ImageIcon(getClass().getResource("/resources/walk6.png"));
	Image walkPhase6 = walk6.getImage();
	
	ImageIcon walk7 = new ImageIcon(getClass().getResource("/resources/walk7.png"));
	Image walkPhase7 = walk7.getImage();
	
	ImageIcon walk8 = new ImageIcon(getClass().getResource("/resources/walk8.png"));
	Image walkPhase8 = walk8.getImage();

	ImageIcon jump1 = new ImageIcon(getClass().getResource("/resources/jump1.png"));
	Image jumpPhase1 = jump1.getImage();
	
	ImageIcon jump2 = new ImageIcon(getClass().getResource("/resources/jump2.png"));
	Image jumpPhase2 = jump2.getImage();
	
	ImageIcon jump3 = new ImageIcon(getClass().getResource("/resources/jump3.png"));
	Image jumpPhase3 = jump3.getImage();
	
	ImageIcon fall1 = new ImageIcon(getClass().getResource("/resources/fall1.png"));
	Image fallPhase1 = fall1.getImage();
	
	ImageIcon fall2 = new ImageIcon(getClass().getResource("/resources/fall2.png"));
	Image fallPhase2 = fall2.getImage();
	
	ImageIcon land = new ImageIcon(getClass().getResource("/resources/land.png"));
	Image landPhase = land.getImage();
	
	Image player = idlePhase;
	
	public fosterMain() {
		frame = new JFrame("Jump Game");
		frame.setMinimumSize(new Dimension(1020, 760));
		frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		frame.addKeyListener(this);
		frame.setResizable(false);
		frame.setLocationRelativeTo(null);
		frame.setVisible(true);
		frame.setIconImage(icon);
	}
	
	public void run() {
		
		long time1 = System.currentTimeMillis();
//		long time2 = System.currentTimeMillis();
		long time3 = System.currentTimeMillis();
		try {
			startMusic();
		} catch (Exception e) {
			e.printStackTrace();
		}
		
		while(running) {
			//old was 50
			if (System.currentTimeMillis() - time1 >= 70) {
				update();
				time1 = System.currentTimeMillis();
			}
//			
//			if (System.currentTimeMillis() - time2 >= 16) {
//				render();
//				time2 = System.currentTimeMillis();
//			}
			if (System.currentTimeMillis() - time3 >= 100) {
				animation();
				time3 = System.currentTimeMillis();
			}
		}
	}
	
	public void animation() {
		
		if (isIdle) {
			player = idlePhase;
		}
		
		if (doJump && isMoving) {
			phase = 0;
			isMoving = false;
		}
		
		if (doJump) {
			if (finished || isMoving) {
				phase = 0;
				finished = false;
				isMoving = false;
			}
			if (phase <= 2) {
				lockMovement = true;
				player = jumpPhase1;
				phase++;
			} else if (phase == 3) {
				playSound("grunt.wav");
				lockMovement = false;
				velocityY = -20;
				doJump = false;
				finished = true;
			}
		}
		
		if (isJumping) {
			if (finished) {
				phase = 0;
				finished = false;
			}
			if (phase == 0) {
				player = jumpPhase2;
			}
			if (isFalling) {
				finished = true;
				isJumping = false;
			}
		}
		
		if (isFalling) {
			if (finished) {
				phase = 0;
				finished = false;
			}
			if (phase == 0 && y < 560) {
				player = fallPhase1;
				phase++;
			} else if (phase == 1 && y < 560) {
				player = fallPhase2;
			} else {
				player = landPhase;
				finished = true;
			}
		}
		
		if (isMoving && isGrounded && !doJump) {
			if (finished) {
				phase = 0;
				finished = false;
			}
			if (phase == 0) {
				player = walkPhase1;
				phase++;
			} else if (phase == 1) {
				player = walkPhase2;
				phase++;
			} else if (phase == 2) {
				player = walkPhase3;
				phase++;
			} else if (phase == 3) {
				player = walkPhase4;
				phase++;
			} else if (phase == 4) {
				player = walkPhase5;
				phase++;
			} else if (phase == 5) {
				player = walkPhase6;
				phase++;
			} else if (phase == 6) {
				player = walkPhase7;
				phase++;
			} else if (phase == 7) {
				player = walkPhase8;
				finished = true;
			}
		}
	}
	
	public void update() {
		
		backgroundX-=10;
		backgroundX2-=10;
		backgroundX3-=10;
		backgroundX4-=10;
		backgroundX5-=10;
		backgroundX6-=10;
		backgroundX7-=10;
		if (!lowCountChange){
			lowestX=backgroundX;
		}
		if(lowestX <=-170) {
			jumpheight=generator.nextInt(10);
			if ((jumpheight - currentJumpHeight > 2) || (currentJumpHeight - jumpheight <2)) {
				int decision = generator.nextInt(2);
				if ((decision ==1) && (currentJumpHeight>2)) {
					jumpheight = currentJumpHeight -2;
				}else{
					jumpheight = currentJumpHeight +2;
				}
			}
			movePixels = jumpheight * oneJump;
			currentJumpHeight=jumpheight;
			if (currentLow==1) {
				jumpheight7 = movePixels;
			}
			else if (currentLow==2) {
				jumpheight1 = movePixels;
			}
			else if(currentLow==3){
				jumpheight2 = movePixels;
			}
			else if(currentLow==4) {
				jumpheight3 = movePixels;
			}
			else if(currentLow==5){
				jumpheight4 = movePixels;
			}
			else if(currentLow==6){
				jumpheight5 = movePixels;
			}
			else if(currentLow==7){
				jumpheight6 = movePixels;
			}
			lowestX=0;
		}
		if (!rightPressed && !leftPressed) {
			isIdle = true;
			isMoving = false;
		} else {
			if (!lockMovement) {
				isMoving = true;
			}
		}
		
		if (velocityY < 0) {
			isJumping = true;
		} else if (velocityY > 0) {
			isFalling = true;
		}
		
		if (isFalling || isJumping) {
			isIdle = false;
		}
		
		if (isGrounded) {
			isFalling = false;
			isJumping = false;
		}
		
		x += velocityX;
		velocityY += gravity;
		y += velocityY;
		if (!lockMovement) {
			if (rightPressed && velocityX < 20 && x < 900) {
				if (velocityX < 0) {
					velocityX += 2;
				} else {
					velocityX++;
				}
			} else if (rightPressed && velocityX >= 10) {
				velocityX = 10;
			}
			if (leftPressed && velocityX > -20 && x > 0) {
				if (velocityX > 0) {
					velocityX -= 2;
				} else {
					velocityX--;
				}
			} else if (leftPressed && velocityX <= -10) {
				velocityX = -10;
			}
			if (rightPressed && x + velocityX > 900) {
				velocityX = 0;
			}
			if (leftPressed && x - velocityX < 0) {
				velocityX = 0;
			}
		}
		if (!leftPressed && !rightPressed && velocityX > 0 && isGrounded) {
			velocityX = 0;
		} else if (!leftPressed && !rightPressed && velocityX < 0 && isGrounded) {
			velocityX = 0;
		}
		
		//Warning shitty way of handling collision follows. Poor logic ahead. Blame David. Its late I'm tired.
		if (y >= 600) {
			y = 600;
			velocityY = 0;
			isGrounded = true;
		} else if(x <=170){
			groundedYCount = getLowCount();
			//first section follows. 
			if (groundedYCount == 1) {
				groundedY = jumpheight1;
			}else if (groundedYCount == 2){
				groundedY = jumpheight2;
			}else if (groundedYCount ==3) {
				groundedY = jumpheight3;
			}else if (groundedYCount ==4) {
				groundedY = jumpheight4;
			}else if (groundedYCount ==5) {
				groundedY = jumpheight5;
			}else if (groundedYCount ==6) {
				groundedY = jumpheight6;
			}else if (groundedYCount ==7) {
				groundedY = jumpheight7;
			}
			if ((y <= groundedY) && (x<=170)) {
				canGround = true;
			} else {
				canGround = false;
			}
			if ((canGround) && groundedY-y <2) {
				y = groundedY;
				isGrounded=true;
			}
		} else if ((x>=170) && (x<=340)) {
			groundedYCount = getLowCount() + 1;
			//first section follows. 
			if (groundedYCount == 8) {
				groundedY = jumpheight1;
			}else if (groundedYCount == 2){
				groundedY = jumpheight2;
			}else if (groundedYCount ==3) {
				groundedY = jumpheight3;
			}else if (groundedYCount ==4) {
				groundedY = jumpheight4;
			}else if (groundedYCount ==5) {
				groundedY = jumpheight5;
			}else if (groundedYCount ==6) {
				groundedY = jumpheight6;
			}else if (groundedYCount ==7) {
				groundedY = jumpheight7;
			}
			if ((y <= groundedY) && (x>=170) && (x<=340)) {
				canGround = true;
			}
			else {
				canGround = false;
			}
			if ((canGround) && groundedY-y <2) {
				y = groundedY;
				isGrounded=true;
			}
		}else if ((x>340) && (x<510)) {
			groundedYCount = getLowCount() + 2;
			//first section follows. 
			if (groundedYCount == 9) {
				groundedY = jumpheight1;
			}else if (groundedYCount == 3){
				groundedY = jumpheight2;
			}else if (groundedYCount ==4) {
				groundedY = jumpheight3;
			}else if (groundedYCount ==5) {
				groundedY = jumpheight4;
			}else if (groundedYCount ==6) {
				groundedY = jumpheight5;
			}else if (groundedYCount ==7) {
				groundedY = jumpheight6;
			}else if (groundedYCount ==8) {
				groundedY = jumpheight7;
			}
			if ((y <= groundedY) && (x>340) && (x<510)) {
				canGround = true;
			}
			else {
				canGround = false;
			}
			if ((canGround) && groundedY-y <2) {
				y = groundedY;
				isGrounded=true;
			}
		}else if ((x>=510) && (x<680)) {
			groundedYCount = getLowCount() + 3;
			//first section follows. 
			if (groundedYCount == 10) {
				groundedY = jumpheight1;
			}else if (groundedYCount == 4){
				groundedY = jumpheight2;
			}else if (groundedYCount ==5) {
				groundedY = jumpheight3;
			}else if (groundedYCount ==6) {
				groundedY = jumpheight4;
			}else if (groundedYCount ==7) {
				groundedY = jumpheight5;
			}else if (groundedYCount ==8) {
				groundedY = jumpheight6;
			}else if (groundedYCount ==9) {
				groundedY = jumpheight7;
			}
			if ((y <= groundedY) && (x>=510) && (x<680)) {
				canGround = true;
			}
			else {
				canGround = false;
			}
			if ((canGround) && groundedY-y <2) {
				y = groundedY;
				isGrounded=true;
			}
		}else if ((x>=650) && (x<=850)) {
			groundedYCount = getLowCount() + 4;
			//first section follows. 
			if (groundedYCount == 11) {
				groundedY = jumpheight1;
			}else if (groundedYCount == 5){
				groundedY = jumpheight2;
			}else if (groundedYCount ==6) {
				groundedY = jumpheight3;
			}else if (groundedYCount ==7) {
				groundedY = jumpheight4;
			}else if (groundedYCount ==8) {
				groundedY = jumpheight5;
			}else if (groundedYCount ==9) {
				groundedY = jumpheight6;
			}else if (groundedYCount ==10) {
				groundedY = jumpheight7;
			}
			if ((y <= groundedY) && (x>=650) && (x<=850)) {
				canGround = true;
			}
			else {
				canGround = false;
			}
			if ((canGround) && groundedY-y <2) {
				y = groundedY;
				isGrounded=true;
			}
		} else if ((x>=850) && (x<1020)) {
			groundedYCount = getLowCount() + 5;
			//first section follows. 
			if (groundedYCount == 12) {
				groundedY = jumpheight1;
			}else if (groundedYCount == 6){
				groundedY = jumpheight2;
			}else if (groundedYCount ==7) {
				groundedY = jumpheight3;
			}else if (groundedYCount ==8) {
				groundedY = jumpheight4;
			}else if (groundedYCount ==9) {
				groundedY = jumpheight5;
			}else if (groundedYCount ==10) {
				groundedY = jumpheight6;
			}else if (groundedYCount ==11) {
				groundedY = jumpheight7;
			}
			if ((y <= groundedY) && (x>=850) && (x<1020)) {
				canGround = true;
			}
			else {
				canGround = false;
			}
			if ((canGround) && groundedY-y <2) {
				y = groundedY;
				isGrounded=true;
			}
		}
		else {
			isGrounded = false;
		}
//		System.out.println("isGrounded " + isGrounded);
//		System.out.println("can ground "  + canGround);
		System.out.println("y "  + y);
//		System.out.println("grounded y "  + groundedY);
		
		
		render();
	}
	
	public int getLowCount() {
		return currentLow;
	}
	
	public void render() {
		//g = frame.getGraphics();
		//g.clearRect(0, 0, frame.getWidth(), frame.getHeight());
		//g.drawImage(sprite, Math.round(x), Math.round(y), 200, 200, frame);
		//g.dispose();
		BufferStrategy bs = frame.getBufferStrategy();
		if (bs==null) {
			frame.createBufferStrategy(3);
			return;
		}
		g = bs.getDrawGraphics();
		g.clearRect(0, 0, frame.getWidth(), frame.getHeight());		
		g.drawImage(picture, backgroundX, jumpheight1,this);
		g.drawImage(picture, backgroundX2, jumpheight2,this);
		g.drawImage(picture, backgroundX3, jumpheight3,this);
		g.drawImage(picture, backgroundX4, jumpheight4,this);
		g.drawImage(picture, backgroundX5,jumpheight5, this);
		g.drawImage(picture, backgroundX6, jumpheight6, this);
		g.drawImage(picture, backgroundX7, jumpheight7,this);
		if (backgroundX <= -170){
			lowCountChange = true;
			currentLow = 2;
			backgroundX = 1020;
			lowestX = -170;
		}else if(backgroundX2<=-170) {
			lowCountChange = true;
			currentLow=3;
			backgroundX2 = 1020;
			lowestX = -170;
		}else if(backgroundX3<=-170) {
			lowCountChange = true;
			currentLow=4;
			backgroundX3 = 1020;
			lowestX = -170;
		}else if(backgroundX4<=-170) {
			lowCountChange = true;
			currentLow=5;
			backgroundX4 = 1020;
			lowestX = -170;
		}else if(backgroundX5<=-170) {
			lowCountChange = true;
			currentLow=6;
			backgroundX5 = 1020;
			lowestX = -170;
		}else if(backgroundX6<=-170) {
			lowCountChange = true;
			currentLow=7;
			backgroundX6 = 1020;
			lowestX = -170;
		}else if(backgroundX7<=-170) {
			lowCountChange = true;
			currentLow=1;
			backgroundX7 = 1020;
			lowestX = -170;
		}
		if (facingRight) {
			g.drawImage(player, Math.round(x), Math.round(y), player.getWidth(frame), player.getHeight(frame), frame);
		} else {
			g.drawImage(player, Math.round(x + 125), Math.round(y), -player.getWidth(frame), player.getHeight(frame), frame);
		}

		g.dispose();
		bs.show();
	}
	
	public void start() throws Exception {
		new Thread(this).start();
		running = true;
	}
	
	public void stop() {
		running = false;
	}
	
	public static void main(String[] args) {
		try {
			new fosterMain().start();
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	/**
	 * This method handle the movement for the character and all other key binds
	 */
	public void keyPressed(KeyEvent key) {
		if (key.getKeyCode() == KeyEvent.VK_RIGHT) { rightPressed = true; facingRight = true;}
		if (key.getKeyCode() == KeyEvent.VK_LEFT) {leftPressed = true; facingRight = false;}
		if (key.getKeyCode() == KeyEvent.VK_UP && isGrounded) {doJump = true;}
		// escape key
		if ((key.getKeyCode() == 27) && (!escape) && (!escapePressed) && (!dead)) {
			escape = true;
			escapePressed = true;
			render();
		} else if ((key.getKeyCode() == 27) && (escape) && (!escapePressed) && (!dead)) {
			escape = false;
			escapePressed = true;
		}
			
}

	/**
	 * This method handles the stopping of movement for the character and
	 * stoping all other key binds
	 */
	public void keyReleased(KeyEvent key) {
		if (key.getKeyCode() == KeyEvent.VK_RIGHT){ rightPressed = false;}
		if (key.getKeyCode() == KeyEvent.VK_LEFT) {leftPressed = false;}
		if ((key.getKeyCode() == 27)  && (escapePressed)) {
		escapePressed = false;
		}
	}
	
	public synchronized void playSound(final String sound) {
		  // The wrapper thread is unnecessary, unless it blocks on the
		  // Clip finishing; see comments.
		      try {
		        Clip clip = AudioSystem.getClip();
		        AudioInputStream inputStream = AudioSystem.getAudioInputStream(getClass().getResource("/resources/" + sound));
		        clip.open(inputStream);
		        clip.start(); 
		      } catch (Exception e) {
		    	  e.printStackTrace();
		      }
		    }
	public void startMusic()throws Exception{
		backgroundMusic = AudioSystem.getAudioInputStream(getClass().getResource(
			"/resources/music.wav"));
		music = AudioSystem.getClip();
		try {
			music.open(backgroundMusic);
			
		} catch (Exception e) {
			e.printStackTrace();
		}
		music.loop(178);
	}


	public void keyTyped(KeyEvent key) {
	
	}
}
